import DataSheetBase from './DataSheetBase.js';

export default class DataSheet_chatmessages extends DataSheetBase {

  constructor(id, updateCb) {
    super(id, updateCb);
    this.requestedKeyPath = "";  // this value can be specified in the React Studio data sheet UI
  }

  makeDefaultItems() {
    // eslint-disable-next-line no-unused-vars
    let key = 1;
    // eslint-disable-next-line no-unused-vars
    let item;

    // The contents of this data sheet will be loaded by plugin 'Firebase (Cloud Firestore)'.
    
    item = {};
    this.items.push(item);
    item['document_key'] = "L1UX2GgMwSWhDRbeDpH7";
    item['timestamp'] = "1589773111967";
    item['message_body'] = "testing3";
    item['sender_username'] = "solomonlo";
    item.key = key++;
    
    item = {};
    this.items.push(item);
    item['document_key'] = "mYazLvomYbl5m6k7OxxH";
    item['timestamp'] = "1589773135026";
    item['message_body'] = "Testing\n";
    item['sender_username'] = "solomonlo";
    item.key = key++;
    
    item = {};
    this.items.push(item);
    item['document_key'] = "zNVYsmoZuJzJ4lhZLhGy";
    item['timestamp'] = "1589773138957";
    item['message_body'] = "HEllo";
    item['sender_username'] = "solomonlo";
    item.key = key++;
    
    item = {};
    this.items.push(item);
    item['document_key'] = "lzmvv9Lm1om9sjgrlCUt";
    item['timestamp'] = "1589774313513";
    item['message_body'] = "hi";
    item['sender_username'] = "sam";
    item.key = key++;
    
    item = {};
    this.items.push(item);
    item['document_key'] = "J4rEASZNeUbmFFAMojD1";
    item['timestamp'] = "1589774329915";
    item['message_body'] = "ok";
    item['sender_username'] = "sam";
    item.key = key++;
    
    item = {};
    this.items.push(item);
    item['document_key'] = "JxKHTsMkczr75Q0f3mv7";
    item['timestamp'] = "1589774359065";
    item['message_body'] = "grocerease";
    item['sender_username'] = "sam";
    item.key = key++;
    
    item = {};
    this.items.push(item);
    item['document_key'] = "4RHp6aVUqdj7Y18qyxeG";
    item['timestamp'] = "1590884431424";
    item['message_body'] = "hi";
    item['sender_username'] = "";
    item.key = key++;
    
    item = {};
    this.items.push(item);
    item['document_key'] = "mbhKRuXQ1PHdEYL35Wkg";
    item['timestamp'] = "1590884442310";
    item['message_body'] = "hey";
    item['sender_username'] = "";
    item.key = key++;
    
    item = {};
    this.items.push(item);
    item['document_key'] = "yKPOCwrk4S6Xjq45Ku4b";
    item['timestamp'] = "1590884511815";
    item['message_body'] = "hey";
    item['sender_username'] = "";
    item.key = key++;
    
    item = {};
    this.items.push(item);
    item['document_key'] = "B2ZxiSHP11DfqonFkY7u";
    item['timestamp'] = "1590884663341";
    item['message_body'] = "Hello";
    item['sender_username'] = "";
    item.key = key++;
    
    item = {};
    this.items.push(item);
    item['document_key'] = "oGeSdvv5bPQksrVOU0Gc";
    item['timestamp'] = "1590884707840";
    item['message_body'] = "hi";
    item['sender_username'] = "";
    item.key = key++;
    
    item = {};
    this.items.push(item);
    item['document_key'] = "bn7Tgzn7Cp7OnRJg946T";
    item['timestamp'] = "1590884710292";
    item['message_body'] = "hi";
    item['sender_username'] = "";
    item.key = key++;
    
    item = {};
    this.items.push(item);
    item['document_key'] = "xFVfUGYNX6rwvOhouvkf";
    item['timestamp'] = "1590905535651";
    item['message_body'] = "sup";
    item['sender_username'] = "";
    item.key = key++;
    
    item = {};
    this.items.push(item);
    item['document_key'] = "8P1Ia0OjN5PHcol0R6yU";
    item['timestamp'] = "1590905541012";
    item['message_body'] = "hello";
    item['sender_username'] = "";
    item.key = key++;
    
    item = {};
    this.items.push(item);
    item['document_key'] = "DlYiuZXmM3IANLS7Lvi3";
    item['timestamp'] = "1590905715269";
    item['message_body'] = "hello";
    item['sender_username'] = "";
    item.key = key++;
    
    item = {};
    this.items.push(item);
    item['document_key'] = "l3usZMarit6FuIewfFXk";
    item['timestamp'] = "1590905718840";
    item['message_body'] = "send";
    item['sender_username'] = "";
    item.key = key++;
    
    item = {};
    this.items.push(item);
    item['document_key'] = "LgYxgxYBdoMlFNREPYXV";
    item['timestamp'] = "1590905723299";
    item['message_body'] = "send3";
    item['sender_username'] = "";
    item.key = key++;
    
    item = {};
    this.items.push(item);
    item['document_key'] = "ry87GezPhUdkkZjmX5uz";
    item['timestamp'] = "1590905727756";
    item['message_body'] = "there";
    item['sender_username'] = "";
    item.key = key++;
    
    item = {};
    this.items.push(item);
    item['document_key'] = "p76RaL1JZJSO0jYdU3Kj";
    item['timestamp'] = "1591067322250";
    item['message_body'] = "hi";
    item['sender_username'] = "";
    item.key = key++;
    
    item = {};
    this.items.push(item);
    item['document_key'] = "TzuatNSMm2ZAIPMtrFHi";
    item['timestamp'] = "1591067406144";
    item['message_body'] = "hi";
    item['sender_username'] = "";
    item.key = key++;
    
    item = {};
    this.items.push(item);
    item['document_key'] = "lq3VcPhSeln5JPJI4hyP";
    item['timestamp'] = "1591067455949";
    item['message_body'] = "hi";
    item['sender_username'] = "";
    item.key = key++;
  }

  
  // this function's implementation is provided by React Studio.
  _fetchComplete = (err, options) => {
    if (err) {
      console.log('** Web service write failed: ', err, options);
    } else {
      if (this.updateCb) this.updateCb(this);
    }
  }
  
  
  addItem(item, options) {
    console.log("add to firebase: ", item);
      
    let isCollectionGroup = options.servicePath.startsWith("group:");
    if (isCollectionGroup) {
      console.log("unable to add to collection group: ", options.servicePath.substring(6));
      return;
    }
  
    const db = this.firebase.firestore();
    const collection = db.collection(options.servicePath);
  
    let addItemPromise;
    if (item.document_key && item.document_key.length > 0) {
      let parsedItem = (({ document_key, ...item }) => (item))( item );
      addItemPromise = collection.doc(item.document_key).set(parsedItem);
    } else {
      addItemPromise = collection.add(item);
    }
    addItemPromise
      .then((docRef) => {
        var addedKey="";
        if (docRef) {
          console.log("Firebase document added with id: ", docRef.id);
          addedKey=docRef.id;
          item.document_key = docRef.id;
          item.document_ref = docRef;
        } else {
          console.log("Firebase document added with id: ", item.document_key);
          addedKey=item.document_key;
        }   
        if (this.onLastAddedDocumentKeyChanged != null) {
          this.onLastAddedDocumentKeyChanged(addedKey);
        }
        //super.addItem(item, options);
      
        this._fetchComplete(null, options);
      })
      .catch((error) => {
        console.error("Error adding document: ", error);
        this._fetchComplete(error, options);
      });
  }
  
  removeItem(item, options) {
    //super.removeItem(item, options);
    
    console.log("delete from firebase: ", item);
  
    //const db = this.firebase.firestore();
    //const collection = db.collection(options.servicePath);
    //const docRef = collection.doc(item.document_key);
    const docRef = item.document_ref;
    
    docRef.delete()
      .then(() => {
        this._fetchComplete(null, options);
      })
      .catch((error) => {
        console.error("Error deleting document: ", error);
        this._fetchComplete(error, options);    
      });
  }
  
  replaceItemByRowIndex(idx, item, options) {
    //super.replaceItemByRowIndex(idx, item, options);
    
    console.log("update in firebase: ", item);
  
    //const db = this.firebase.firestore();
    //const collection = db.collection(options.servicePath);
    //const docRef = collection.doc(item.document_key);
    const docRef = item.document_ref;
    
    docRef.update((({ key, document_ref, document_key, ...item }) => (item))( item ))
      .then(() => {
        this._fetchComplete(null, options);
      })
      .catch((error) => {
        console.error("Error updating document: ", error);
        this._fetchComplete(error, options);    
      });
  }
  

}
